title = "My Courses"
url = "/my-courses"
layout = "default"
components[] = "courses"

[session]
security = "user"
redirect = "/login"
== 
<?php
use Penguin\Ielts\Models\Enrollment;
use Illuminate\Support\Facades\Auth;

function onStart()
{
    // load current user and enrollments for the page template
    $user = Auth::user();
    $this['user'] = $user;

    if ($user) {
        $this['enrollments'] = Enrollment::with('course')
            ->where('user_id', $user->id)
            ->where('payment_status', 'paid')
            ->get();
    } else {
        $this['enrollments'] = collect([]);
    }
}
?>
==
<div class="container">
    <h1>My Courses</h1>

    {% if user %}
        {% if enrollments|length %}
            <ul>
                {% for enroll in enrollments %}
                    <li>
                        <h3>{{ enroll.course.title }}</h3>
                        <p>Enrolled at: {{ enroll.created_at|date("Y-m-d H:i") }}</p>
                        <p>Paid at: {% if enroll.paid_at %}{{ enroll.paid_at|date("Y-m-d H:i") }}{% else %}â€”{% endif %}</p>
                        <a href="{{ 'course/courses'|page({ id: enroll.course.id }) }}" class="btn btn-sm btn-primary">Open course</a>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>You have no purchased courses yet.</p>
            <p><a href="{{ 'course/courses'|page }}">Browse courses</a></p>
        {% endif %}
    {% else %}
        <p>Please <a href="{{ 'login'|page }}">login</a> to see your courses.</p>
    {% endif %}
</div>

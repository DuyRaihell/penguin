title = "My Courses"
url = "/my-courses"
layout = "default"
components[] = "courses"

[session]
security = "user"
redirect = "/login"
== 
<?php
use Penguin\Ielts\Models\Enrollment;
use Illuminate\Support\Facades\Auth;

function onStart()
{
    // load current user and enrollments for the page template
    $user = Auth::user();
    $this['user'] = $user;

    if ($user) {
        // eager load course and its lessions so documents are available in the template
        $enrollments = Enrollment::with('course.lessions')
            ->where('user_id', $user->id)
            ->where('payment_status', 'paid')
            ->get();

        // compute full document URL for each lesson using AWS_URL
        $awsUrl = env('AWS_URL') ?: '';
        $enrollments->each(function($enroll) use ($awsUrl) {
            if ($enroll->course && $enroll->course->lessions) {
                foreach ($enroll->course->lessions as $lesson) {
                    $doc = $lesson->document ?? null;
                    if ($doc) {
                        if (!preg_match('/^https?:\/\//i', $doc)) {
                            $lesson->full_document = rtrim($awsUrl, '/') . '/' . ltrim($doc, '/');
                        } else {
                            $lesson->full_document = $doc;
                        }
                    } else {
                        $lesson->full_document = null;
                    }
                }
            }
        });

        $this['enrollments'] = $enrollments;
    } else {
        $this['enrollments'] = collect([]);
    }
}
?>
==
<div class="container">
    <h1>My Courses</h1>

    {% if user %}
        {% if enrollments|length %}
            <ul>
                {% for enroll in enrollments %}
                    <li>
                        <h3>{{ enroll.course.title }}</h3>
                        <p>Enrolled at: {{ enroll.created_at|date("Y-m-d H:i") }}</p>
                        <p>Paid at: {% if enroll.paid_at %}{{ enroll.paid_at|date("Y-m-d H:i") }}{% else %}â€”{% endif %}</p>
                        <a href="{{ 'course/courses'|page({ id: enroll.course.id }) }}" class="btn btn-sm btn-primary">Open course</a>

                        {# Render course lessons and download links if any #}
                        {% if enroll.course.lessions is defined and enroll.course.lessions|length %}
                            <div class="course-lessions mt-2">
                                <strong>Lessons:</strong>
                                <ul>
                                    {% for l in enroll.course.lessions %}
                                        <li>
                                            {{ l.title }}
                                            {% if l.full_document %}
                                                <a href="{{ l.full_document }}" class="btn btn-xs btn-outline-primary" target="_blank" download>Download</a>
                                            {% elseif l.document %}
                                                {# fallback to raw document value if full_document missing #}
                                                <a href="{{ l.document }}" class="btn btn-xs btn-outline-primary" target="_blank" download>Download</a>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>You have no purchased courses yet.</p>
            <p><a href="{{ 'course/courses'|page }}">Browse courses</a></p>
        {% endif %}
    {% else %}
        <p>Please <a href="{{ 'login'|page }}">login</a> to see your courses.</p>
    {% endif %}
</div>

title = "VNPAY Payment Result"
url = "/vnpay/return"
layout = "default"

[session]
==
<?php
use Penguin\Vnpay\Classes\VnpayService;
use Penguin\Ielts\Models\Enrollment;

function onStart()
{
    $service = new VnpayService();
    $this['verified'] = $service->verifyReturn($_GET);
    $this['responseCode'] = $_GET['vnp_ResponseCode'] ?? null;
    $this['transactionId'] = $_GET['vnp_TxnRef'] ?? null;
    $this['amount'] = isset($_GET['vnp_Amount']) ? $_GET['vnp_Amount'] / 100 : null;
    $this['bankCode'] = $_GET['vnp_BankCode'] ?? null;

    $vnp = new VnpayService();
    $params = $_GET;

    if ($service->verifyReturn($params)) {
        $txnRef = $_GET['vnp_TxnRef'] ?? null;
        $enrollment = $service->getEnrollment($txnRef);

        if ($enrollment) {
            $enrollment->payment_status = 'paid';
            $enrollment->paid_at = now();
            $enrollment->save();

            $this['message'] = "Payment successful! You now have access to your course.";
        } else {
            $this['message'] = "Enrollment not found.";
        }
    } else {
        $this['message'] = "Payment failed or invalid signature.";
    }
}
?>
==
<div class="container mx-auto mt-10 text-center">
    {% if verified and responseCode == '00' %}
        <div class="bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-lg inline-block">
            <h2 class="text-2xl font-bold mb-2">{{ message }}</h2>
            <p class="text-lg">Transaction ID: <strong>{{ transactionId }}</strong></p>
            <p>Amount: <strong>{{ amount|number_format(0, '.', ',') }} VND</strong></p>
            <p>Bank: <strong>{{ bankCode }}</strong></p>
            <a href="{{ 'course/courses'|page }}" class="mt-4 inline-block px-6 py-2 bg-green-600 rounded hover:bg-green-700">Back to Courses</a>
        </div>
    {% else %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg inline-block">
            <h2 class="text-2xl font-bold mb-2">{{ message }}</h2>
            {% if not verified %}
                <p>Invalid signature â€” payment verification failed.</p>
            {% elseif responseCode %}
                <p>Error Code: <strong>{{ responseCode }}</strong></p>
            {% else %}
                <p>Unknown error occurred.</p>
            {% endif %}
            <a href="/" class="mt-4 inline-block px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700">Try Again</a>
        </div>
    {% endif %}
</div>
